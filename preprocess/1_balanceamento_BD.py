# -*- coding: utf-8 -*-

# Funções
import numpy as np
import os, glob
from imgaug import augmenters as iaa
from imgaug import parameters as iap
import imgaug as ia
import imageio.v2 as imageio
import datetime
import sys

# Add the current directory to the PYTHONPATH
sys.path.insert(0, os.getcwd())
from models import utils


"""# quantizar"""

def quantizar(dst, CATEGORIES, _k):
  for i in range(_k):
    k=i+1
    folder=dst+'/k'+str(i+1)
    print('k', folder)

    for cat in CATEGORIES:
      path =folder+'/'+cat+'/*.jpg'
      images_path = glob.glob(path)
      print(cat, len(images_path))

"""# iaa"""

def augmentation(IMG_IN_ARR,FACTOR,SAVE_DIR='',prifix='_Aug.',tipo='png'):
  ia.seed(1)
  seq = iaa.Sequential([
      iaa.GaussianBlur(
          sigma=iap.Uniform(0.0, 0.3)
      ),
      iaa.contrast.LinearContrast( # uniformly from the interval [0.75, 1.25]
          iap.Choice(
              [0.75, 1.25],
              p=[0.3, 0.7]
          )
      ),
      iaa.MultiplyAndAddToBrightness(
          mul=(0.5, 1.5),
          add=(-30, 30)
      ),
      iaa.Affine(
          rotate=(-25, 25),
          translate_percent={
              "x": (-0.2, 0.2),
              "y": (-0.2, 0.2)
          }

      ),
      iaa.Fliplr(0.5),
      iaa.Flipud(0.5) # vertically flip 100% of the images

      ],
      random_order=True)  # apply augmenters in random order
  c=0
  Aug_im_arr=[]

  for i in range(FACTOR):
    img_aug=seq(images=IMG_IN_ARR)
    print(len(img_aug))

    for j in img_aug:
      nm=SAVE_DIR+'/'+str(c)+prifix+tipo
      if not(SAVE_DIR==''):
        print('save_img: ',nm)
        imageio.imwrite(nm, j)  #write all changed images
      Aug_im_arr.append(j)
      c+=1
  print('total de imagens aumentadas ', len(Aug_im_arr))
  return Aug_im_arr

"""# procedimento
* ler as imagens e o total
* aplicar aumento de dados
"""

def calc(goal, size_imgs, IMG_IN_ARR,tipo, SAVE_DIR=''):
  if size_imgs<goal:
    dif=goal-size_imgs
    #                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           print('size_imgs ', size_imgs, 'dif ', dif)
    inteiro=dif//size_imgs
    frac=goal%size_imgs
    if inteiro >0:
      Aug_im_arr=augmentation(IMG_IN_ARR,inteiro,SAVE_DIR,prifix='_Aug.',tipo=tipo)
    if frac>0:
      IMG_FRAC=IMG_IN_ARR[:frac]
      Aug_im_arr=augmentation(IMG_FRAC,1,SAVE_DIR,prifix='_Augf.',tipo=tipo)
    print(f'dif: {dif}, inteiro: {inteiro}, frac: {frac}')

def load_img_folder_type(PATH_IN, tipo='png'):
  """
  --> load images in dataSet unlabel
  :param: PATH_IN: path the dataSet
  :param: tipo: specifique format image, standar 'png'
  :return: array of the images
  """
  images = []
  query=PATH_IN+'/*.'+tipo
  print(query)

  images_path = glob.glob(query)
  for img_path in images_path:
      img = imageio.imread(img_path)
      images.append(img)
  images=np.array(images)
  print(len(images))
  return images

"""# fração
* valor da fração
* slice dataframe[frac] de imagens
* fator =1
"""

def run(DST_BASE, CATEGORIES, goal, tipo, _K, SAVE_DIR, verbose=0):
    str_time = datetime.datetime.now().replace(microsecond=0)
    data_ini=datetime.date.today()
    
    _csv_head = SAVE_DIR + 'head_balanceamento'+str(data_ini)+'.csv'
    data=[["algoritmo", "base", "iniciio", "fim", "tempo", 'data']]
    print(data)
    utils.add_row_csv(_csv_head, data)
    
    for i in range(_K):
      k=i+1
      #ler as imagens das pastas k
      path_k=DST_BASE+'/Train/k'+str(k)
      print('path_k ', path_k)
      for j in CATEGORIES:
        #ler o total de imagens na pasta
        path_sub=path_k+'/'+j
        print('path_sub: ',path_sub)
        query=path_sub+"/*."+tipo
        images_path = glob.glob(query)
        size_imgs =len(images_path)
        print('size_imgs ', size_imgs)
        if verbose==1:
          print(path_sub, size_imgs)
      
        #ler e aumentar os dados
        images_o=load_img_folder_type(path_sub, tipo)
        calc(goal, size_imgs, images_o, tipo, path_sub)
        #break
      #break
      end_time = datetime.datetime.now().replace(microsecond=0)
      delay=end_time-str_time
      
      data=[["1_balanceamento_BD_ALL1_VISTAS_k10B600_010424.py", DST_BASE, str_time, end_time, delay, datetime.date.today()]]
      print(data)
      utils.add_row_csv(_csv_head, data)
      

"""# Main"""

if __name__=="__main__":
  tipo='png'  
  BD_AUG = '/media/jczars/4C22F02A22F01B22/Pollen_classification_view/BD/CPD1_Cr_Rs_500/'
  path_cat = BD_AUG+'Train/k1'
  SAVE_DIR=''
  goal = 500
  _K=10

  CATEGORIES = sorted(os.listdir(path_cat))

  run(BD_AUG, CATEGORIES, goal, tipo, _K, SAVE_DIR, verbose=1)